# Feature Specification: WorkLog — プロジェクト先行フロー（仕様駆動・PR レポート）

**Feature**: 004-project-first-flow  
**Created**: 2026-02-08  
**Status**: Draft  
**目的**: ログイン → プロジェクト設定 → AI が監査観点を提案 → ユーザー承認 → GitHub リポ自動作成（Spec Kit/docs 付き）→ そのリポの PR 発生時に、設定内容に基づく AI レポートを自動作成する。

---

## ユーザーが望む流れ（要約）

1. **GitHub でログイン** — 既存の NextAuth + GitHub OAuth で開始
2. **アプリでプロジェクト設定** — 解決したい課題・目的、厳守すべき点などを入力
3. **AI が監査すべき点を洗い出し** — 設定内容から「監査すべき点」を AI が提案し、ユーザーに承認を求める
4. **承認が通る** — GitHub にプロジェクト（リポジトリ）を自動作成し、**Spec Kit / 仕様駆動開発で必要な情報を docs として含めた状態**にする
5. **その GitHub で PR が発生したとき** — 最初に設定した内容（目的・厳守点・承認済み監査観点）に基づいて **AI がレポートを自動作成**する

---

## 現行 003 との違い

| 項目 | 現行 003 | 希望フロー（004） |
|------|----------|-------------------|
| 入口 | リポ接続 or Intent 作成 or プロビジョニング | **常に「プロジェクト設定」から開始** |
| プロジェクト設定 | Intent（goal/constraints/success）は別々 | **1 プロジェクト = 目的・厳守点・監査観点を一括で定義** |
| 監査観点 | リスクエンジン（Low/Med/High）と承認 | **AI が「監査すべき点」を提案 → ユーザー承認** |
| リポ作成 | 承認後に POST /api/provisioning で実行 | **承認後に自動で GitHub リポ作成 + Spec Kit/docs を配置** |
| PR 時の成果物 | キャリア資産（AssetCard）or 別途 AgentRun | **そのプロジェクトの設定に基づく「レポート」を自動作成** |

---

## User Scenarios（004 用）

### US1 - ログインとプロジェクト設定（Priority: P1）

**シナリオ**: ユーザーが GitHub でログインし、アプリ内で「プロジェクト」を 1 件作成する。設定内容は以下とする。

- **解決したい課題・目的**（例: 〇〇を自動化したい、品質を一定に保ちたい）
- **厳守すべき点**（例: セキュリティ要件、コンプライアンス、パフォーマンス下限）
- （オプション）成功基準、スコープ、制約

**完了条件**:
- 設定が保存され、次のステップ「監査観点の提案」に進める。

---

### US2 - AI が監査すべき点を提案し、ユーザーが承認（Priority: P1）

**シナリオ**: プロジェクト設定が完了すると、AI（Vertex AI 等）が設定内容（目的・厳守点）から「監査すべき点」を洗い出し、一覧としてユーザーに提示する。ユーザーは内容を確認し、承認・編集・却下する。

**監査すべき点の例**:
- セキュリティ: 認証・認可の抜けがないか
- パフォーマンス: 〇〇 ms 以下を満たしているか
- 規約: 命名規則・テスト必須など

**完了条件**:
- ユーザーが承認した「監査観点」がプロジェクトに紐づいて保存される。
- 承認が完了するまで GitHub リポは作成されない。

---

### US3 - 承認後に GitHub リポ自動作成と Spec Kit/docs の配置（Priority: P1）

**シナリオ**: 監査観点の承認が通ると、システムが GitHub にリポジトリを自動作成する。さらに **Spec Kit や仕様駆動開発に必要な情報を docs として含めた状態**にする（例: `specs/`, `contracts/`, `docs/` 等のレイアウトと初期ファイル）。

**完了条件**:
- リポが作成され、指定した構造（Spec Kit 想定の docs）がコミットされている。
- どのプロジェクト設定・承認から作成されたかが証跡として残る（provisioning_events と同様）。

---

### US4 - そのリポで PR 発生時に、設定に基づく AI レポート作成（Priority: P1）

**シナリオ**: 上記で作成した GitHub リポで PR が発生（open/update/merge 等）したとき、Webhook で WorkLog がイベントを受け取る。システムは **そのプロジェクトに紐づく「目的・厳守点・承認済み監査観点」** を参照し、AI で PR の内容を評価して **レポート** を生成する。

**レポートの性質**:
- キャリア資産（AssetCard）ではなく、**プロジェクトの監査観点に沿った評価レポート**（例: 各観点の充足状況、指摘、推奨）。
- 固定スキーマ（例: 観点 ID、判定、コメント、証拠参照）を想定。

**完了条件**:
- PR イベント → ジョブ enqueue → プロジェクト設定を取得 → AI がレポート生成 → 保存・一覧表示可能。
- レポートは PR とプロジェクトに紐づき、監査可能。

---

## データ・フロー（概念）

1. **Project**  
   - 目的、厳守点、成功基準、スコープ等  
   - ステータス: 下書き / 監査観点承認済み / プロビジョニング済み

2. **AuditCriteria（監査観点）**  
   - プロジェクトに紐づく  
   - AI 提案 + ユーザー承認済みの一覧  
   - 例: `{ id, projectId, title, description, category, order }`

3. **Approval（監査観点の承認）**  
   - プロジェクト単位で「監査観点一覧」に対する 1 回の承認  
   - 承認済み → プロビジョニング可能

4. **Provisioning**  
   - 承認済みプロジェクト → GitHub リポ作成 + Spec Kit/docs 配置  
   - 既存の provisioning_events と同様の証跡

5. **Repository（WorkLog 側）**  
   - 自動作成したリポを「このプロジェクトのリポ」として登録  
   - PR Webhook を登録

6. **PR Event → Report**  
   - PR 発生 → リポに紐づくプロジェクトを取得 → そのプロジェクトの目的・厳守点・承認済み監査観点を入力に AI がレポート生成 → 保存

---

## 成功基準（004）

- ログインから、プロジェクト設定・監査観点承認・リポ作成までが一連の流れで完了できる。
- 作成されたリポに Spec Kit / 仕様駆動開発で必要な docs が含まれている。
- そのリポで PR が発生したとき、**設定内容に基づく** AI レポートが自動作成される。
- すべてのアクション（設定・承認・プロビジョニング・レポート）がトレーサブルである。

---

## 現行実装への当てはめ（方針）

- **ログイン**: 現行のまま（GitHub OAuth）。
- **プロジェクト設定**: 新規エンティティ **Project**（目的・厳守点・成功基準等）を追加。Intent を「プロジェクト用」に特化して使うか、Project を新設するかは設計で決定。
- **監査観点の提案と承認**:  
  - 設定保存後に AI で「監査すべき点」を生成 → **AuditCriteria** として保存。  
  - ユーザーが一覧を承認（一括 or 個別）→ **Approval**（プロジェクト単位）を記録。  
  - 現行の Approvals Inbox の概念を「プロジェクトの監査観点承認」に流用可能。
- **リポ作成と docs**: 現行の provisioning を拡張し、**Spec Kit 用の docs（specs/, contracts/, docs/ 等）をコミットする**処理を追加。
- **PR → レポート**:  
  - 現行の PR Event Processor / Asset Generator の代わりに、または並行して、**「プロジェクトに紐づくリポの PR」かどうかを判定**し、紐づく場合は **プロジェクトの監査観点に基づくレポート生成ジョブ** を enqueue。  
  - 出力は **Report**（固定スキーマ）として保存し、一覧・監査レポートで参照可能にする。

---

## 次のステップ案

1. この spec をベースに **data-model（Project, AuditCriteria, Report）** と **API 契約** を追加・更新する。
2. **画面フロー**（プロジェクト作成 → 設定入力 → 監査観点確認・承認 → リポ作成 → PR レポート一覧）をワイヤーで整理する。
3. 現行 003 のどこを拡張し、どこを新規実装するか **tasks.md** に落とす。

必要であれば、次のどれから進めますか？  
- データモデル（Project, AuditCriteria, Report）の詳細  
- API 一覧（プロジェクト CRUD、監査観点提案・承認、レポート取得）  
- 画面・フロー単位のタスク一覧（tasks.md）
