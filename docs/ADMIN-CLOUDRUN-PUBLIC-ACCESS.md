# 管理者向け: Cloud Run の未認証アクセス（allUsers）を許可する

Cloud Run サービスに `allUsers`（未認証の誰でも）で `roles/run.invoker` を付与しようとすると、次のエラーになることがあります。

```
FAILED_PRECONDITION: One or more users named in the policy do not belong to a permitted customer,
perhaps due to an organization policy.
```

組織ポリシーで「許可されたドメイン外のプリンシパル」が制限されているためです。**組織の管理者**が、次のいずれかで対応します。

---

## 方法 1: 組織ポリシーを確認・変更する（推奨）

### 1-1. 組織ポリシー一覧を開く

1. [Google Cloud Console](https://console.cloud.google.com/) にログインする（組織管理者のアカウントで）。
2. 画面上部の **プロジェクト選択** で、**組織** または **フォルダ** を選ぶ（プロジェクト単体ではなく、親の組織/フォルダで操作する）。
3. 左メニュー **「IAM と管理」** → **「組織のポリシー」**  
   - 直リンク: <https://console.cloud.google.com/iam-admin/orgpolicies>
4. 「組織のポリシー」一覧が表示される。

### 1-2. 関係しやすいポリシー

次のようなポリシーが **オン** だと、`allUsers` の付与がブロックされやすいです。

| ポリシー名（日本語 UI 例） | ポリシー ID | 説明 |
|---------------------------|-------------|------|
| ドメイン限定の共有 | `iam.allowedPolicyMemberDomains` | IAM に追加できるプリンシパルのドメインを制限する。`allUsers` はドメインに属さないため弾かれる。 |
| 信頼できるプライベート プロジェクトの制限 | （Project レベルで設定される場合あり） | プロジェクトが「信頼できる」として扱われ、一部制限が緩和される。 |

### 1-3. 「ドメイン限定の共有」を編集する場合

1. **組織のポリシー** 一覧で **「ドメイン限定の共有」**（`iam.allowedPolicyMemberDomains`）をクリック。
2. **「管理」** または **「ポリシーを管理」** をクリック。
3. 次のどちらかで対処する。
   - **このプロジェクトだけ許可する**
     - **「カスタマイズ」** を選び、**「ルールを追加」** で、
       - **適用対象**: 「プロジェクト」を選び、対象プロジェクト（例: `worklog-adb04`）を指定。
       - **ポリシー値**: 「許可」または「未設定」にして、このプロジェクトではドメイン制限を適用しない。
   - **組織全体で allUsers を許可しない方針のまま、Cloud Run だけ例外にしたい**
     - 多くの場合、 org policy では「Cloud Run の allUsers だけ」を細かく例外にするのは難しいため、**対象プロジェクト単位**で上記のように緩和する運用が現実的です。

4. **「保存」** で確定する。反映に数分かかることがあります。

### 1-4. 対象を「フォルダ」や「プロジェクト」にしている場合

- 組織のポリシーは **組織 > フォルダ > プロジェクト** の階層で継承されます。
- **「ドメイン限定の共有」** が「組織」でオンになっている場合、  
  **「プロジェクト worklog-adb04 ではこのポリシーをオーバーライドして無効／緩和する」** ようなルールを、そのプロジェクト（またはその親フォルダ）に追加する形で対応します。
- 編集画面で「適用対象」を **プロジェクト** にし、  
  プロジェクト ID `worklog-adb04` を指定したうえで、そこでは制限をかけない（許可／未設定）にします。

---

## 方法 2: gcloud で組織ポリシーを確認する

どのポリシーが効いているかコマンドで確認したい場合の例です。

```bash
# 組織 ID を確認（組織でない場合はフォルダ ID）
gcloud organizations list

# プロジェクトが属する組織/フォルダのポリシー一覧（組織 ID は上で確認した値に置き換え）
gcloud resource-manager org-policies list --project=worklog-adb04

# 「ドメイン限定の共有」の現状を確認
gcloud resource-manager org-policies describe iam.allowedPolicyMemberDomains --project=worklog-adb04
```

`iam.allowedPolicyMemberDomains` が `allowedValues` でドメイン制限をかけている場合、そのままだと `allUsers` は許可されません。  
緩和するにはコンソールの「組織のポリシー」から、対象プロジェクト用のルールを追加・編集します。

---

## 方法 3: ポリシーを変えずに「このプロジェクトだけ」許可する（別案）

「組織ポリシーは触りたくないが、このプロジェクトでは allUsers を付けたい」場合、**組織ポリシーの例外**が使えるかどうかは設定次第です。

- **組織のポリシー** の編集画面で、  
  「適用対象 = プロジェクト worklog-adb04」、「このプロジェクトではポリシーを適用しない（または許可）」  
  のような **オーバーライド** ができるか確認する。
- できる場合は、そのプロジェクト用にオーバーライドを追加すると、そのプロジェクトにだけ `allUsers` を付与できるようになります。

---

## ポリシー変更後に実施するコマンド（開発者・運用者向け）

ポリシー側で `allUsers` が許可されたあと、**Cloud Run の Invoker** は次のコマンドで付与します。

```bash
gcloud run services add-iam-policy-binding worklog \
  --region=asia-northeast1 \
  --member=allUsers \
  --role=roles/run.invoker
```

「One or more users named in the policy do not belong to a permitted customer」が解消され、未認証でサービス URL にアクセスできるようになります。

---

## まとめ：どこを編集するか

| やりたいこと | 編集する場所 |
|--------------|--------------|
| `allUsers` がブロックされるのを緩和する | **コンソール** → **IAM と管理** → **組織のポリシー** → **「ドメイン限定の共有」** を開き、対象プロジェクト（またはフォルダ）で「許可／未設定」になるようルールを追加・編集する。 |
| ポリシーを変えたあとに allUsers を付与する | ターミナルで上記の `gcloud run services add-iam-policy-binding` を実行する。 |

組織によっては「信頼できるプライベート プロジェクト」など別のポリシーが効いている場合もあります。  
そのときは、**組織のポリシー** 一覧で「IAM」「ドメイン」「公開」などに関連しそうな項目を開き、  
**適用対象** に `worklog-adb04` が含まれていないか、含まれている場合はそのルールを緩和できないか、を順に確認してください。
